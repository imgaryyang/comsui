define(function(require,exports,module){var t=require("./backdrop"),e=require("scaffold/path"),i=require("component/pagination"),n=require("component/popupTip"),a=sessionStorage,o=global_const.loadingImg,s=(global_config.root,$(".dashboard")),c=Backbone.View.extend({initialize:function(){},hide:function(){this.$el.addClass("hide")},show:function(){s.addClass("hide"),this.$el.removeClass("hide")}}),r=c.extend({events:{"click .goback":"onClickBack"},initialize:function(t){r.__super__.initialize.apply(this,arguments),t&&this.render(t)},render:function(t){var e='<p class="notice-title"><strong></strong></p><p class="content-notice" style="white-space:pre-wrap;"></p>';this.$(".bd").html(e),this.$(".bd").find("strong").text(unescape(t.mtitle)),this.$(".bd").find(".content-notice").text(unescape(t.content))},onClickBack:function(t){t.preventDefault(),this.trigger("showNotice"),this.hide()}}),l=c.extend({events:{"click .notice-item":"onClickItem"},initialize:function(){l.__super__.initialize.apply(this,arguments),this.render()},render:function(){this.pagination=new i({el:this.$("> .inner"),template:_.template($("#noticeTableTmpl").html()),pageRecordNum:7})},onClickItem:function(t){t.preventDefault();var e=$(t.target).parents("tr").data();e.content=$(t.target).parents("tr").find(".data-content").html(),this.trigger("showNoticeDetail",e)}}),h=c.extend({events:{"click [data-key]":"onClickTabMenuItem","change .selectpicker":"onChangeSelectpicker","click a[data-vue-path]":"onClickVueHref","click a[data-path]":"onClickHref"},initialize:function(){if(h.__super__.initialize.apply(this,arguments),this.tabContentCache={},this.tabContentEl=this.$(".tab-content"),this.tabMenuEl=this.$(".nav-tabs"),this.selectpickerEl=this.$(".selectpicker"),this.on("request",function(){this.tabContentEl.html(o.clone())}),this.initActiveTab(),this.$el.data("disable-toggle"))return void this.fetchTabContent()},initActiveTab:function(){if(a)var t=a.getItem("active_tab_key"),e=this.$el.find("a[data-key="+t+"]").parent("li");e&&0!=e.length||(e=this.$el.find(".nav-tabs li").first()),e.addClass("active")},onClickVueHref:function(t){t.preventDefault();var i=$(t.currentTarget),n=this.getSeletedProject();n.financialContractIds=JSON.stringify(JSON.parse(n.financialContractIds).map(function(t){return+t}));var a=e.stringifyQueryObject(n),o=i.data("vue-path"),s=i.data("hash");s=s?s+"&"+a:a,location.assign(encodeURI(o+"?"+s))},onClickHref:function(t){t.preventDefault();var i=$(t.currentTarget),n=this.getSeletedProject(),a=e.stringifyQueryObject(n),o="t="+Date.now(),s=i.data("path"),c=i.data("hash"),r=i.data("search");r=r?r+"&"+o:o,c=c?c+"&"+a:a,location.assign(encodeURI(s+"?"+r+"#"+c))},onChangeSelectpicker:function(){this.fetchTabContent()},onClickTabMenuItem:function(t){t.preventDefault();var e=$(t.currentTarget),i=e.parent();i.is(".active")||(this.tabMenuEl.children().removeClass("active"),i.addClass("active"),a&&a.setItem("active_tab_key",e.attr("data-key")),this.fetchTabContent())},getActiveTabMenu:function(){return this.tabMenuEl.find(".active")},getActiveTabMenuHref:function(){var t=this.getActiveTabMenu(),e=t.find("a"),i=e.data("href");return i},getSeletedProject:function(){var t={},e=this.selectpickerEl.selectpicker("val"),i=[],n=[];return null!=e&&e.forEach(function(t){i.push(t.split("&")[0]),n.push(t.split("&")[1])}),t.financialContractIds=JSON.stringify(i),t.financialContractUuids=JSON.stringify(n),t},fetchTabContent:function(){var t=this,e=this.getActiveTabMenuHref();if(e){var i=this.getSeletedProject();t.trigger("request"),$("<div/>").load(e,i,function(e,i,n){if("error"==i||200!=n.status)t.tabContentEl.html("系统异常请稍候重试");else if($(e).data("dashboard-item")){t.tabContentEl.html(e);var a=0;t.tabContentEl.find("[data-total]").each(function(){a+=+$(this).data("total")});var o=t.getActiveTabMenu();o.find(".total").html(a)}else t.tabContentEl.html("系统异常请稍候重试");t.trigger("refresh",e,i)})}}}),d=Backbone.View.extend({initialize:function(){if(s.length){this.views={},this.views.toDo=new h({el:s.get(0)}),this.views.notice=new l({el:s.get(1)}),this.views.noticeDetail=new r({el:s.get(2)});var e=this;this.views.noticeDetail.on("showNotice",function(){e.views.notice.show()}),this.views.notice.on("showNoticeDetail",function(t){e.views.noticeDetail.render(t),e.views.noticeDetail.show()}),this.backdrop=new t({zIndex:7}),this.listenTo(this.backdrop,"close:backdrop",function(){s.addClass("hide")}),this.listenTo(this.backdrop,"showView",function(t){"item-todo"==t?e.showView("toDo"):"item-notice"==t&&e.showView("notice")}),this.listenTo(this.backdrop,"open:backdrop",function(t){var e=this;"item-todo"==t?(e.views.toDo.fetchTabContent(),e.showView("toDo")):"item-notice"==t&&e.showView("notice")});var e=this,i=$(".web-g-hd .btn-toggle-dashboard");i.on("click",function(t){if(0==$("#modifyPasswordTime").val())return void n.show("首次登陆，请修改密码！","",[{text:"确定",style:"success",handler:function(){this.hide()}}]);if(!$(s.get(0)).data("disable-toggle")){var i=$(t.target).parent().attr("class");e.backdrop.toggle(i)}}),$(window).on("keyup.dashboard",function(t){27==t.keyCode&&e.backdrop.hide()})}},showView:function(t,e){this.views[t]&&(this.views[t].render(e),this.views[t].show())}});module.exports=new d});