define(function(require,exports,module){var e=require("baseView/baseFormView").FormDialogView,t=require("component/popupTip"),a=global_config.root,o=jQuery,s=e.extend({template:_.template(o("#modifyPenaltyTmpl").html(),{variable:"obj"}),actions:{submit:function(e){return a+"/payment-manage/order/"+e+"/edit"}},initialize:function(){s.__super__.initialize.call(this,arguments),this.defineValidator()},defineValidator:function(){this.validator=this.$(".form").validate({rules:{comment:{required:!0,maxlength:50}}})},validate:function(){return this.validator.form()},save:function(){var e=this,t=this.extractDomData();t.orderId=this.model.get("orderId");var a={url:this.actions.submit(this.model.get("orderId")),type:"post",dataType:"json",data:t};a.success=function(a){0==a.code,e.model.trigger("modify:penaltyAmount",t,a)},o.ajax(a)},submitHandler:function(){this.validate()&&(this.save(),this.hide())}}),n=Backbone.View.extend({el:".content",events:{"click #modifyPenalty":"onClickModifyPenalty","mouseover .showPopover":"onShowPopover","mouseout .showPopover":"onClosePopover","click .closeOrder":"onClickCloseOrder"},actions:{chargesDetail:function(e){return a+"/payment-manage/order/"+e+"/chargesDetail"},closeNormalOrder:a+"/payment-manage/order/close"},initialize:function(e){this.initModel(e.orderId)},onShowPopover:function(e){var t=o(e.target),a=this;this.timer=setTimeout(function(){var e={url:a.actions.chargesDetail(a.model.get("orderId")),dataType:"json"};e.success=function(e){t.popover({content:function(){if(0==e.code){if(o.isEmptyObject(e.data))return'<div><span class="text-muted">还款本金: -</span><br/><span class="text-muted">还款利息: -</span><br/><span class="text-muted">贷款服务费: -</span><br/><span class="text-muted">技术维护费: -</span><br/><span class="text-muted">其他费用: -</span><br/><span class="text-muted">逾期罚息: -</span><br/><span class="text-muted">逾期违约金: -</span><br/><span class="text-muted">逾期服务费: -</span><br/><span class="text-muted">逾期其他费用: -</span><br/><span class="text-muted">逾期费用合计: -</span><br/></div>';var t=0,a=0,s=0,n=0,r=0,i=0,d=0,l=0,c=0,m=0;if(!_.isEmpty(e.data.data)){var u=e.data.data;t=u.loanAssetPrincipal,a=u.loanAssetInterest,s=u.loanServiceFee,n=u.loanTechFee,r=u.loanOtherFee,i=u.overdueFeePenalty,d=u.overdueFeeObligation,l=u.overdueFeeService,c=u.overdueFeeOther,m=u.totalOverdueFee}return'<div><span class="text-muted">还款本金:</span>'+(+t).formatMoney(2,"")+'<br/><span class="text-muted">还款利息:</span>'+(+a).formatMoney(2,"")+'<br/><span class="text-muted">贷款服务费:</span>'+(+s).formatMoney(2,"")+'<br/><span class="text-muted">技术维护费:</span>'+(+n).formatMoney(2,"")+'<br/><span class="text-muted">其他费用:</span>'+(+r).formatMoney(2,"")+'<br/><span class="text-muted">逾期罚息:</span>'+(+i).formatMoney(2,"")+'<br/><span class="text-muted">逾期违约金:</span>'+(+d).formatMoney(2,"")+'<br/><span class="text-muted">逾期服务费:</span>'+(+l).formatMoney(2,"")+'<br/><span class="text-muted">逾期其他费用:</span>'+(+c).formatMoney(2,"")+'<br/><span class="text-muted">逾期费用合计:</span>'+(+m).formatMoney(2,"")+"<br/></div>"}return"<div>"+e.message+"</div>"}}),t.popover("toggle")},o.ajax(e)},300)},onClosePopover:function(e){e.preventDefault(),clearTimeout(this.timer),o("body").find(".popover").popover("hide")},initModel:function(e){var t={};t.penalty=+this.$(".penalty-amount").data("value"),t.comment=this.$(".comment").text().trim(),t.orderId=e,t.assetRecycleDate=this.$(".asset-recycle-date").text().trim(),t.customerName=this.$(".customer-name").text().trim(),t.numbersOfOverdueDays=this.$(".numbers-of-overdue-days").text().trim(),this.model=new Backbone.Model(t)},onClickModifyPenalty:function(){var e=new s({model:this.model});this.model.once("modify:penaltyAmount",function(e,a){0==a.code?(t.show("操作成功"),setTimeout(function(){location.reload()},1e3)):t.show(a.message||"操作失败，请重试")}),e.show()},onClickCloseOrder:function(e){var a=this;t.show("确认关闭该结算单？",null,[{text:"确定",style:"success",handler:function(){var e={url:a.actions.closeNormalOrder,dataType:"json",type:"post",data:{orderId:a.model.get("orderId"),type:"normal"}};e.success=function(e){0==e.code?location.reload():t.show(e.message)},o.ajax(e),this.hide()}},{text:"取消",style:"default",handler:function(){this.hide()}}])}});module.exports=n});