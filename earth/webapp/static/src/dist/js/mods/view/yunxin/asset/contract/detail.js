define(function(require,exports,module){var t=require("baseView/baseFormView").FormDialogView,e=require("component/popupTip"),i=require("component/dialogView"),a=require("component/areaSelect"),o=require("./tab-switch").ReleaseTabContentView,n=require("./tab-switch").RepayTabContentView,r=global_config.root,s=(global_const.loadingImg,jQuery),c=t.extend({template:_.template(s("#repurchaseTmpl").html(),{variable:"data"}),initialize:function(){c.__super__.initialize.apply(this,arguments),this.defineValidator()},defineValidator:function(){s.validator.addMethod("rightformatAmount",function(t,e){return this.optional(e)||/^(([1-9][0-9]*)|(([0]\.\d{1,2}|[1-9][0-9]*\.\d{1,2})))$/.test(t)},"请输入正确的金额格式"),this.validator=this.$(".form").validate({rules:{repurchaseAmount:{required:!0,rightformatAmount:!0}}})},validate:function(){return this.validator.form()},submit:function(){if(!this.loading){this.loading=!0;var t=this.extractDomData();t.id=this.model.id;var i=this,a={url:r+"/contracts/detail/repurchase",data:t,type:"post",dataType:"json"};a.success=function(t){0==t.code?(e.show("操作成功"),setTimeout(function(){location.reload()},1e3)):e.show(t.message)},a.complete=function(){i.loading=!1},s.ajax(a)}},submitHandler:function(){var t=this;if(this.validate()){var e=new i({title:"提示",bodyInnerTxt:"该金额可能与系统计算的金额不相等，是否确认提交?"});e.on("goahead",function(){t.submit(),e.hide()}),e.show()}}}),l=t.extend({template:_.template(s("#prepaymentTmpl").html(),{variable:"obj"}),initialize:function(){l.__super__.initialize.apply(this,arguments),this.defineValidator()},defineValidator:function(){this.validator=this.$(".form").validate({rules:{type:"required",assetInitialValue:{required:!0,number:!0}}})},validate:function(){var t=!0,e=this.$(".datetimepicker-form-control");if(!e.val()){var t=!1;e.parent().addClass("error")}return this.validator.form()&&t},save:function(){var t=this.extractDomData();t.contractId=this.model.get("contractId");var i={url:r+"/contracts/prepayment/save",data:t,type:"post",dataType:"json"};i.success=function(t){0==t.code?(this.hide(),e.show("提交成功!")):e.show(t.message)}.bind(this),setTimeout(function(){s.ajax(i)},450)},submitHandler:function(){if(this.validate()){var t=this,i=this.$("input[name=assetInitialValue]"),a=i.val(),o=this.model.get("amount");return a<=o?void this.save():void e.show("该金额可能与系统计算的金额不相等，是否确认提交?",null,[{text:"关闭",style:"default",handler:function(){i.val(o),e.hide()}},{text:"确定",style:"success",handler:function(){t.save(),e.hide()}}])}}}),d=t.extend({template:_.template(s("#editCustomerInfoTmpl").html(),{variable:"obj"}),actions:{submit:r+"/modifyContractAccount/repaymentInfo/modify"},initialize:function(){d.__super__.initialize.call(this,arguments),this.defineValidator(),this.areaSelect=new a({el:this.$(".area-select")}),this.$(".selectpicker").selectpicker("render")},defineValidator:function(){this.validator=this.$(".form").validate({rules:{bankAccount:"required",cityCode:"required",provinceCode:"required"}})},validate:function(){var t=!0;return"请选择"===this.$(".filter-option").html()?(this.$(".dropdown-toggle").addClass("error"),t=!1):(t=!0,this.$(".dropdown-toggle").removeClass("error")),this.validator.form()&&t},save:function(){var t=this,e=s("[name=contractId]").val().trim();if(e){var i=this.extractDomData();i.contractId=e,i.bankCode=s("[name=bankCode]").val();var a={url:this.actions.submit,type:"post",dataType:"json",data:i};a.success=function(e){t.model.trigger("model:edit-customer-info",e,i)},s.ajax(a)}},submitHandler:function(){this.validate()&&(this.save(),this.hide())}}),u=t.extend({template:_.template(s("#terminateContractTmpl").html(),{variable:"obj"}),actions:{submit:r+"/contracts/invalidate"},initialize:function(){u.__super__.initialize.call(this,arguments),this.defineValidator()},defineValidator:function(){this.validator=this.$(".form").validate({rules:{comment:{required:!0,maxlength:50}}})},validate:function(){return this.validator.form()},save:function(){var t=this,e={url:this.actions.submit,type:"post",dataType:"json"};e.success=function(e){t.model.trigger("model:terminate-contract",e)},this.$(".form").ajaxSubmit(e)},submitHandler:function(){this.validate()&&(this.save(),this.hide())}}),h=Backbone.View.extend({el:".content",events:{"click #terminateContract":"onClickTerminateContract","click .edit-customer-info":"onClickEditCustomerInfo","click .tab-menu-item":"onClickTabMenuItem","mouseover .showPopover":"showPopover","click .icon-bankcard":"onClickBankcard","mouseout .showPopover":"showPopover","click .repurchase":"onClickRepurchase","click .prepay":"onCLickPrepay","click .download-file":"onClickDownloadFile"},initialize:function(t){this.initModel(),this.initTabContentView(),s(window).on("click",function(){s("body").find(".popover").last().hasClass("clickShow")&&s("body").find(".popover").popover("hide")})},initModel:function(){this.model=new Backbone.Model;var t={};t.contractId=this.$("[name=contractId]").val().trim(),t.contractNo=this.$(".contractNo").text().trim(),t.amount=this.$(".amount").text().trim(),t.customer=this.$(".customer").text().trim(),t.idCardNum=this.$(".idcard-num").text().trim(),t.customerSource=this.$(".customer-source").text().trim(),t.bank=this.$(".bank").text().trim(),t.bankCode=this.$(".account-bankCode").text().trim(),t.provinceCode=this.$(".bank-provinceCode").text().trim(),t.cityCode=this.$(".bank-cityCode").text().trim(),this.model.set(t)},showPopover:function(t){t.preventDefault();var e=s(t.target),i=e.siblings(".account").html();e.popover({content:i}),e.popover("toggle")},onClickBankcard:function(t){t.preventDefault(),this.showPopover(t);var e=s(t.target);return e.on("shown.bs.popover",function(){s("body").find(".popover").last().addClass("clickShow")}),e.on("hidden.bs.popover",function(){e.removeClass("active")}),e.toggleClass("active"),!1},initTabContentView:function(){var t=this.tabContentViews={};t.release=new o({el:this.$(".tab-content-item-release").get(0),$tabMenuItem:this.$(".tab-menu-item-release"),model:this.model}),t.repay=new n({el:this.$(".tab-content-item-repay").get(0),$tabMenuItem:this.$(".tab-menu-item-repay"),model:this.model}),t.release.hide(),t.repay.hide(),this.activeTabContentView=t.repay,this.activeTabContentView.show(),this.$(".tabs").show()},handleAfterPopupHide:function(t){0==t.code?(e.show("操作成功"),setTimeout(function(){location.reload()},1e3)):e.show(t.message||"操作失败，请重试")},onClickEditCustomerInfo:function(t){t.preventDefault();var e=new d({model:this.model});this.model.once("model:edit-customer-info",this.handleAfterPopupHide),e.show()},onClickTerminateContract:function(){var t=new u({model:this.model});this.model.once("model:terminate-contract",this.handleAfterPopupHide),t.show()},onClickTabMenuItem:function(t){t.preventDefault();var e=s(t.currentTarget),i=e.data("target"),a=this.tabContentViews[i];this.activeTabContentView.hide(),a.show(),this.activeTabContentView=a},onClickRepurchase:function(t){var i=s(t.target).data("contract-id");if(!this.loading){this.loading=!0;var a=this,o={url:r+"/contracts/detail/repurchaseAmount",data:{id:i},type:"post",dataType:"json"};o.success=function(t){if(0==t.code){var a=new Backbone.Model(t.data);a.id=i;var o=new c({model:a});o.show()}else e.show(t.message)},o.complete=function(){a.loading=!1},s.ajax(o)}},onCLickPrepay:function(t){t.preventDefault();var i=this.model.get("contractId"),a={url:r+"/contracts/prepayment/check",type:"post",data:{contractUuid:i},dataType:"json"};a.success=function(t){if("0"===t.code){var a={};a.amount=t.data.defaultAmount[0],a.contractId=i;var o=new Backbone.Model(a),n=new l({model:o});n.show()}else e.show(t.message)},s.ajax(a)},onClickDownloadFile:function(t){t.preventDefault();var e=this.model.get("contractId"),i={url:r+"/contracts/download",type:"get",data:{contractId:e},dataType:"json"};i.success=function(t){"0"===t.code?window.location.href=r+"/contracts/download?contractId="+e:(s(".download-file").addClass("hide"),s(".no-file").removeClass("hide"))},s.ajax(i)}});module.exports=h});