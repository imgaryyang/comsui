define(function(require,exports,module){require("component/autocomplete");var e=require("baseView/tableContent"),t=require("component/popupTip"),n=global_config.root,o=Backbone.Model.extend({refund:function(e){e.journalVoucherUuid=this.get("uuid");var t=this,o={url:n+"/capital/customer-account-manage/payment-order-list/refund",data:e,type:"post",dataType:"JSON"};o.success=function(e){t.trigger("refund:success",e)},o.complete=function(){t.trigger("refund:complete")},this.trigger("refund:start"),$.ajax(o)}}),a=e.extend({events:{"click .refund":"onClickRefund","click .voucher":"onClickVoucherLink"},packParams:function(e){var t={};return t.uuid=e.data("uuid"),t.sourceDocumentNo=e.data("sourceDocumentNo"),t.counterPartyAccount=e.find(".counter-party-account").text(),t.bookingAmount=e.find(".booking-amount").text(),t.counterPartyName=e.find(".counter-party-name").text(),t.journalVoucherNo=e.find(".journal-voucher-no").text(),t},onClickVoucherLink:function(e){e.preventDefault();var o={url:n+"/capital/customer-account-manage/payment-order-list/query-voucher-detail",data:{sourceDocumentUuid:$(e.target).closest("tr").data("source-document-uuid")},dataType:"json"};o.success=function(e){if(0==e.code){var o=e.data.voucher,a="";if(!o)return;"商户付款凭证"===o.voucherSource?a=n+"/voucher/business/detail/"+o.id:"主动付款凭证"===o.voucherSource?a=n+"/voucher/active#/capital/voucher/active/"+o.voucherNo+"/detail":"第三方扣款凭证"===o.voucherSource&&(a=n+"/voucher/thirdParty#/capital/voucher/third-party/"+o.uuid+"/detail"),a&&location.assign(a)}else t.show(e.message)},$.ajax(o)},onClickRefund:function(e){e.preventDefault();var n=$(e.target);if(!n.is(".disabled")){var a=this,u=n.parents("tr"),r=this.packParams(u),c=new o(r);c.on("refund:start",function(){n.addClass("disabled")}),c.on("refund:success",function(e){if(0==e.code){var n=_.template($("#RefundSuccessTmpl").html());t.show(n(c.toJSON())),a.query()}else t.show(e.message)}),c.on("refund:complete",function(){n.removeClass("disabled")});var i=_.template($("#RefundTmpl").html());t.show(i(c.toJSON()),"退款",[{text:"关闭",style:"default",handler:function(){this.hide()}},{text:"确定",style:"success",handler:function(){var e=this.$("#appendix").val();c.refund({appendix:e})}}])}}});exports.PaymentOrderListView=a});