define(function(require,exports,module){var e=require("component/popupTip"),t=require("component/pagination"),i=require("component/dialogView"),a=global_config.root,n=global_const.loadingImg,s=jQuery,r={initialize:function(e){this.$tabMenuItem=e.$tabMenuItem,this.mInitialize&&this.mInitialize(e)},hide:function(){this.$el.hide(),this.$tabMenuItem.removeClass("active")},show:function(){this.$el.show(),this.$tabMenuItem.addClass("active")}},l=Backbone.View.extend({events:{"click .expand":"onClickExpand"},orderDetailTemplate:_.template(s("#orderDetailTmpl").html()||""),initialize:function(){this.$loading=s('<tr><td colspan="8" align="center"></td></tr>').find("td").append(n.clone()),this.expanded=!1,this.on("request:orderdetail",function(){this.$el.after(this.$loading)}),this.on("response:orderdetail",function(t){if(this.$loading.remove(),0==t.code){var i=this.orderDetailTemplate(t.data);this.$el.after(i)}else e.show(t.message)})},onClickExpand:function(e){e.preventDefault(),this.toggleOrderDetail()},toggleOrderDetail:function(){this.expanded?this.collapseOrderDetail():this.expandOrderDetail()},collapseOrderDetail:function(){this.expanded=!1,this.$el.removeClass("active");var e=this.$el.next(".bill-card-box");e.remove()},expandOrderDetail:function(){this.expanded=!0,this.$el.addClass("active");var e={remittanceApplicationUuid:this.$el.data("remittance-application-uuid")},t={url:"./detail/planlist",type:"get",dataType:"json",data:e};t.success=function(e){this.trigger("response:orderdetail",e)}.bind(this),this.trigger("request:orderdetail"),s.ajax(t)}}),o=Backbone.View.extend(s.extend({},r,{mInitialize:function(e){this.$(".item-release").toArray().forEach(function(e,t){var i=new l({el:e});0==t&&i.expandOrderDetail()})}})),c=Backbone.Collection.extend({actions:{fetch:function(){return a+"/contracts/detail/"+this.contractId},submit:function(){return a+"/contracts/detail/updateRepaymentPlan"}},initialize:function(e,t){c.__super__.initialize.apply(this,arguments),this.contractId=t.contractId},fetch:function(e){var t={url:this.actions.fetch.call(this),data:{versionNo:e},dataType:"json"};t.success=function(e){0==e.code&&this.reset(e.data.list),this.trigger("sync")}.bind(this),this.trigger("request"),s.ajax(t)},submit:function(e,t){var i=t?t:[],a=this;this.rightModel=!0;for(var n=0;n<i.length;n++)i[n].rightAttr||(a.rightModel=!1);if(this.each(function(e){if(e.get("canBeModifed")){e.get("rightAttr")||(a.rightModel=!1);var t=_.pick(e.toJSON(),"assetRecycleDate","assetPrincipal","assetInterest","serviceCharge","maintenanceCharge","otherCharge");i.push(t)}}),this.rightModel){var r={type:"post",dataType:"json",url:this.actions.submit(),data:{data:JSON.stringify(i),contractId:this.contractId,modifyCode:e}};r.success=function(e){0==e.code&&this.add(t,{silent:!0}),this.trigger("submit",e)}.bind(this),s.ajax(r)}}}),h=Backbone.View.extend({tagName:"tr",template:{template:_.template(s(".block-replay-plan .repay-plan-item").html(),{variable:"obj"})},render:function(){var e=this.model.toJSON(),t=this.template.template(e);return this.$el.html(t),this}}),d=Backbone.View.extend({tagName:"tr",template:_.template(s(".block-replay-plan .edit-repay-plan-item").html(),{variable:"obj"}),events:{"click .delete":function(t){t.preventDefault();var i=this;e.show("即将删除该还款计划是否继续？","",[{text:"继续",style:"success",handler:function(){if(this.hide(),i.model.get("isCreate"))return void i.model.destroy();var a=s(t.target).closest("tr");0==a.siblings().length?e.show("还款计划不能删光哦！"):(i.model.clear("idAttribute"),i.model.destroy())}},{text:"取消",style:"default",handler:function(){this.hide()}}])}},initialize:function(){this.listenTo(this.model,"extract",this.save),this.listenTo(this.model,"destroy",this.remove)},render:function(){var e=this.model.toJSON(),t=this.template(e);return this.$el.html(t),this},save:function(){var e=this.$el.find("[name=assetRecycleDate]").val().trim(),t=this.$el.find("[name=assetPrincipal]").val().trim(),i=this.$el.find("[name=assetInterest]").val().trim(),a=this.$el.find("[name=serviceCharge]").val().trim(),n=this.$el.find("[name=maintenanceCharge]").val().trim(),s=this.$el.find("[name=otherCharge]").val().trim(),r={assetRecycleDate:e,assetPrincipal:""==t?"0":t,assetInterest:""==i?"0":i,serviceCharge:""==a?"0":a,maintenanceCharge:""==n?"0":n,otherCharge:""==s?"0":s},l=this.validateAttr(r);this.model.set(r),this.model.set("rightAttr",l)},validateAttr:function(e){var t=/^([0-9]\d{0,9}|0)([.]?|(\.\d{1,2})?)$/,i=!0;return""==e.assetRecycleDate?(this.$el.find("[name=assetRecycleDate]").addClass("error"),this.$el.find(".input-group-addon").css("border-color","red"),i=!1):(this.$el.find("[name=assetRecycleDate]").removeClass("error"),this.$el.find(".input-group-addon").css("border-color","#ccc"),i=!0),e.assetPrincipal.match(t)?(this.$el.find("[name=assetPrincipal]").removeClass("error"),i&&(i=!0)):(this.$el.find("[name=assetPrincipal]").addClass("error"),i=!1),e.assetInterest.match(t)?(this.$el.find("[name=assetInterest]").removeClass("error"),i&&(i=!0)):(this.$el.find("[name=assetInterest]").addClass("error"),i=!1),e.serviceCharge.match(t)?(this.$el.find("[name=serviceCharge]").removeClass("error"),i&&(i=!0)):(this.$el.find("[name=serviceCharge]").addClass("error"),i=!1),e.maintenanceCharge.match(t)?(this.$el.find("[name=maintenanceCharge]").removeClass("error"),i&&(i=!0)):(this.$el.find("[name=maintenanceCharge]").addClass("error"),i=!1),e.otherCharge.match(t)?(this.$el.find("[name=otherCharge]").removeClass("error"),i&&(i=!0)):(this.$el.find("[name=otherCharge]").addClass("error"),i=!1),i}}),p=Backbone.View.extend({events:{"change .select-version":"onChangeVersion","click .cancel":"toCancel","click .submit":"submit","click .create":"create","click .edit-repay-plan":"toEdit","change [name=assetPrincipal]":"changeAssetPrincipal"},template:{normal:_.template(s(".block-replay-plan .normal").html()),edit:_.template(s(".block-replay-plan .edit").html())},initialize:function(){this.createCacheRepayPlanList=new c([],{contractId:this.model.get("contractId")}),this.listenTo(this.createCacheRepayPlanList,"add",this.addOneRepayPlan),this.listenTo(this.createCacheRepayPlanList,"remove",this.changePrincipal),this.repayPlanList=new c([],{contractId:this.model.get("contractId")}),this.listenTo(this.repayPlanList,"reset",this.addAllRepayPlan),this.listenTo(this.repayPlanList,"add",this.addOneRepayPlan),this.listenTo(this.repayPlanList,"remove",this.changePrincipal),this.listenTo(this.repayPlanList,"submit",function(t){0==t.code?(e.show("操作成功"),setTimeout(function(){location.reload()})):e.show(t.message||"操作失败，请重试")}),this.currentVersion=this.$("[name=activeVersionNo]").val(),this.repayPlanList.fetch(this.currentVersion)},changeAssetPrincipal:function(e){var t=s(e.target).val().trim();""==t?(s(e.target).removeClass("error"),this.changePrincipal()):/^([0-9]\d{0,9}|0)([.]?|(\.\d{1,2})?)$/.test(t)?(s(e.target).removeClass("error"),this.changePrincipal()):s(e.target).addClass("error")},changePrincipal:function(){for(var e=this.$(".assetPrincipal"),t=0,i=0;i<e.length;i++){var a,n=e.eq(i);a=n.is("input")?parseFloat(n.val()):parseFloat(n.html().replace(/,/g,"")),_.isNaN(a)||(t+=a)}this.residualPrincipal=this.principal-t,this.$(".residual-principal").text(this.residualPrincipal.formatMoney(2,"")),this.residualPrincipal<0?this.$(".residual-principal").css("color","red"):this.$(".residual-principal").css("color","#333")},addAllRepayPlan:function(){this.$(".bd tbody").empty();for(var e=this.repayPlanList,t=0,i=0,a=0,n=0,s=0,r=0,l=0,o=e.models.length;l<o;l++){var c=e.at(l);this.addOneRepayPlan(c),t+=void 0==c.get("repayPrincipal")?0:c.get("repayPrincipal"),i+=void 0==c.get("repayProfit")?0:c.get("repayProfit"),a+=void 0==c.get("loanServiceFee")?0:c.get("loanServiceFee"),n+=void 0==c.get("techMaintenanceFee")?0:c.get("techMaintenanceFee"),s+=void 0==c.get("otherFee")?0:c.get("otherFee")}r=t+i+s+a+n,this.$(".principal").text(t.formatMoney(2,"")),this.$(".profit").text(i.formatMoney(2,"")),this.$(".loanServiceFee").text(a.formatMoney(2,"")),this.$(".techMaintenanceFee").text(n.formatMoney(2,"")),this.$(".otherFee").text(s.formatMoney(2,"")),this.$(".totalAmount").text(r.formatMoney(2,"")),this.isEdit&&(this.principal=t,this.residualPrincipal=0,this.$(".residual-principal").text(this.residualPrincipal.formatMoney(2,"")))},addOneRepayPlan:function(e){if(e.set("isEdit",this.isEdit),this.isEdit)var t=new d({model:e});else var t=new h({model:e});this.$(".bd tbody").append(t.render().$el)},toCancel:function(){this.createCacheRepayPlanList.reset(),this.repayPlanList.fetch(this.currentVersion),this.toNormal()},toNormal:function(){this.isEdit=!1;var e=this.template.normal({version:this.currentVersion});this.$el.html(e),this.addAllRepayPlan()},toEdit:function(){this.isEdit=!0;var e=this.template.edit({version:this.currentVersion});this.$el.html(e),this.addAllRepayPlan()},create:function(){var e={assetRecycleDate:"",assetPrincipal:"",assetInterest:"",serviceCharge:"",maintenanceCharge:"",otherCharge:"",isCreate:!0,canBeModifed:!0};this.createCacheRepayPlanList.add(e)},submit:function(){if(this.residualPrincipal<0){var e=new i({bodyInnerTxt:"计划还款本金与原版本不相等！",excludeGoahed:!0});return void e.show()}var t=s("[name = modifyCode]").val();this.repayPlanList.each(function(e){e.get("canBeModifed")&&e.trigger("extract")}),this.createCacheRepayPlanList.each(function(e){e.trigger("extract")});var a=this.createCacheRepayPlanList.toJSON();this.repayPlanList.submit(t,a)},onChangeVersion:function(){0==this.$(".select-version").get(0).selectedIndex?this.$(".edit-repay-plan").show():this.$(".edit-repay-plan").hide(),this.currentVersion=this.$(".select-version").val(),this.repayPlanList.fetch(this.currentVersion)}}),m=Backbone.View.extend(s.extend({},r,{mInitialize:function(){this.repayPlanView=new p({el:this.$(".block-replay-plan").get(0),model:this.model}),this.repayPlanView.toNormal(),this.model.get("contractId")&&(this.repaymentHistorysView=new t({el:this.$(".repayment-historys").get(0),pageRecordNum:99999,queryAction:a+"/contracts/detail/repaymentHistorys/"+this.model.get("contractId")}))}}));exports.ReleaseTabContentView=o,exports.RepayTabContentView=m});