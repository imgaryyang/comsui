define(function(require,exports,module){var t=require("scaffold/util"),e=require("component/pageControl"),a=require("scaffold/path"),r=require("./exportPreviewDialogView"),o=jQuery,i=global_const.loadingImg.clone(),s=t.extractValueFromDifferentDom,n=t.isIE(),l=Backbone.View.extend({template:_.template(o("#tableFieldTmpl").html()||""),el:".content",events:{"click #lookup":"_queryByParams","change .lookup-params":function(t){o(t.target).parents(".operations").length||o(t.target).is("[autoquery=false]")||o(t.target).hasClass("select-key-word")||this._queryByParams()},"keyup .lookup-params":function(t){o(t.target).parents(".operations").length||n&&13==t.which&&o(t.target).change()},"click .redirect,.prev,.next,.first-page,.last-page":"onClickPageNavigateBtn","keyup .redirect-form":"onKeyupRedirectForm","click .check-box":"onClickCheckbox","click .clear-input":"onClickClearInput","click .sort":"onClickSortBtn","click #exportExcel,.export-excel,.export[data-action]":"onClickExport","click .statistical-amount":"showStatisticalAmountPopover"},initialize:function(){this.lookupParamsEl=this.$(".lookup-params").first(),this.tableListEl=this.$(".data-list"),this.queryAction=this.tableListEl.data("action"),this.autoload=this.tableListEl.data("autoload"),this.initialQueryParams=this.parseInitialQueryParams(),this.initLookupParams(),this.initSortParams(),this.initPageControl(),this.initCheckOperate(),o(document).on("click","a[href]",o.proxy(function(t){if(history.replaceState){var e=o(t.target);if(e.attr("target"))return;var r=e.attr("href");if(!r||"#"===r||/^javascript:/.test(r))return;var i=t.target.href.replace(/#.*/,""),s=location.href.replace(/#.*/,"");if(i==s)return;var n=this.collectParams();n.pageIndex=this.pageControl.pageIndex;var l=encodeURI(a.stringifyQueryObject(n));history.replaceState({},"","#"+l)}},this)),this.autoload&&this.getFirstPageData(),o("body").on("click",function(t){var e=o(t.target);!e.hasClass("pagecontrol-show-popover")&&o(".popover").length>0&&!e.hasClass("popover")&&0===e.parent(".popover-content").length&&0===e.parent(".popover-title").length&&0===e.parent(".popover").length&&"popover"!==e.data("toggle")&&o(".popover").popover("destroy")})},showStatisticalAmountPopover:function(t){t.preventDefault();var e=o(t.target);this.destroyOtherPopover();var a,r=this.$(".selectpicker").first().selectpicker("val"),i=!1;e.popover(),null==r?a="还未选择信托项目":r.length>1?a="项目数量>1超出统计范围":(a="金额统计中...",i=!0),e.data("bs.popover").options.content=a,e.popover("show"),this.trigger("show-popover:amountStatistics",i)},destroyOtherPopover:function(){o(".popover").length<=0||o(".popover").popover("destroy")},initCheckOperate:function(){var t=this,e=function(t,e){for(var a=0;a<t.length;a++){var r=t.eq(a);r.is(":disabled")||r.is(".disabled")||(r[0].checked=e)}};this.on("checkall.tablelist",function(a,r){var o=t.$(".check-box");e(o,a),t.trigger("checkbox.tablelist",a,r)}),this.on("checkitem.tablelist",function(a,r){if(a===!1){var o=t.$(".check-box-all");e(o,a),t.trigger("checkbox.tablelist",a,r)}})},initSortParams:function(){for(var t=this.initialQueryParams,e=this.tableListEl.find(".sort[data-paramname]"),a=0;a<e.length;a++){var r=e.eq(a),o=r.data("paramname");if(o){var i=t[o];i&&(r.removeClass("none desc asc"),r.addClass(i.toLowerCase()))}}},initLookupParams:function(){for(var t=this.initialQueryParams,e=this.lookupParamsEl.find(".real-value"),a=0;a<e.length;a++){var r=e.eq(a),o=r.data("paramname")||r.data("params")||r.attr("name");if(o){var i=t[o];if(r.is(".selectpicker"))null!=i&&r.val(i);else if(null!=i){r.val(i);var s=r.prev(".datetimepicker-form-control");s.length>0&&s.val(i)}}}},initPageControl:function(){var t=this.tableListEl,a=null!=this.initialQueryParams.pageIndex?this.initialQueryParams.pageIndex:1,r={el:this.$(".page-control").get(0),url:this.queryAction,pageIndex:a};this.pageControl=new e(r),this.pageControl.on("next:pagecontrol prev:pagecontrol redirect:pagecontrol",o.proxy(this.refreshTableDataList,this)),this.pageControl.on("request",function(){var e='<tr><td style="text-align: center; padding: 25px 0;" colspan="100"></td></tr>',a=o(e).find("td").html(i);t.find("tbody").html(a)}),this.pageControl.on("pagecontrol:bad",function(e){var a='<tr class="nomore"><td style="text-align: center;" colspan="100">'+e.message+"</td></tr>";t.find("tbody").html(a)})},parseInitialQueryParams:function(){var t=decodeURI(location.hash.slice(1)),e=a.parseQueryString(t);return e},getFirstPageData:function(){var t=this.collectParams(),e=this.pageControl.pageIndex;this.pageControl.redirect(e,t)},polish:function(t){return t},setPageControlOptions:function(t){this.pageControl.setOptions(t)},getPageControlOptions:function(){return this.pageControl.getOptions()},refreshTableDataList:function(t,e,a,r){if(this.template){var o;o=t.length<1?'<tr class="nomore"><td style="text-align: center;" colspan="100">没有更多数据</td></tr>':this.template({list:this.polish(t)}),this.tableListEl.find("tbody").html(o),this.trigger("refreshdata.tablelist",t,e,a,r)}},collectQueryParams:function(t){for(var e=this.lookupParamsEl.find(".real-value"),a=0,r=e.length;a<r;a++)o.extend(t,s(e.eq(a)));return t},collectSortParams:function(t){var e=this.tableListEl.find("thead .sort"),a={};return o.each(e,function(t,e){var r=o(e),i=r.data("paramname"),s=r.hasClass("desc")?"DESC":r.hasClass("asc")?"ASC":"";i&&s&&(a.sortField=i,a.isAsc="ASC"===s)}),o.extend(t,a),t},collectParams:function(){var t={};return this.collectQueryParams(t),this.collectSortParams(t),t=this.filterKeyWord(t)},filterKeyWord:function(t){var e=t.selectKeyWord,a=t.keyWords;return void 0==a?_.omit(t,"selectKeyWord"):(t[e]=a,_.omit(t,"selectKeyWord","keyWords"))},_queryByParams:function(){this.shouldChangePageIndex=!1;var t=this.collectParams();this.pageControl.redirect(1,t)},query:function(){this._queryByParams()},refresh:function(){var t=this.collectParams();this.pageControl.refresh(t)},checkAll:function(t,e){this.allChecked=t,this.trigger("checkall.tablelist",t,e)},checkItem:function(t,e){this.itemChecked=t,this.trigger("checkitem.tablelist",t,e)},onClickCheckbox:function(t){var e=t.target.checked,a=o(t.target);a.is(".check-box-all")?this.checkAll(e,a):this.checkItem(e,a)},onChangeFormValue:function(){this.shouldChangePageIndex=!0},onClickClearInput:function(t){o(t.target).prev().val("")},onKeyupRedirectForm:function(t){if(13===t.keyCode){if(this.shouldChangePageIndex===!0)return void this._queryByParams();var e=this.collectParams();this.pageControl.importPageIndexRedirect(e)}},onClickPageNavigateBtn:function(t){if(t.preventDefault(),this.shouldChangePageIndex===!0)return void this._queryByParams();var e=o(t.target),a=this.collectParams();e.hasClass("prev")?this.pageControl.prev(a):e.hasClass("next")?this.pageControl.next(a):e.hasClass("redirect")?this.pageControl.importPageIndexRedirect(a):e.hasClass("first-page")?this.pageControl.first(a):e.hasClass("last-page")&&this.pageControl.last(a)},onClickSortBtn:function(t){var e=o(t.currentTarget),a=this.tableListEl.find("thead .sort");a.not(e.get(0)).removeClass("desc asc").addClass("none"),e.hasClass("desc")?e.removeClass("desc").addClass("asc"):e.hasClass("asc")?e.removeClass("asc").addClass("desc"):e.removeClass("none").addClass("desc"),this._queryByParams()},onClickExport:function(t){t.preventDefault();var e=this.tableListEl.find("tbody").children(),i=0==e.length||e.first().is(".nomore");if(!i){var s=o(t.target),n=s.data("action"),l=s.data("preview-action"),c=s.data("preview-template");if(l&&c&&n){var h=a.format({path:n,query:this.collectParams()}),p=a.format({path:l,query:this.collectParams()}),d=new r({itemTemplate:_.template(o(c).html()),trigger:t.target,downloadAction:h,queryAction:p});d.show()}else if(n){var h=a.format({path:n,query:this.collectParams()});window.open(h,"_download")}}}});l.extend=function(t){var e=Backbone.View.extend.apply(this,arguments);return e.prototype.events=_.extend({},this.prototype.events,t.events),e},module.exports=l});