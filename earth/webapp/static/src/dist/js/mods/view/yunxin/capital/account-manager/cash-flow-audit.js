define(function(require,exports,module){require("component/autocomplete");var t=require("baseView/tableContent"),e=require("component/popupTip"),i=require("component/dialogView"),a=require("view/baseFormView").FormDialogView,l=require("./cash-flow-audit-entity"),o=require("scaffold/path"),n=(l.CashFlowAuditModel,l.CashFlowAuditCollection),s=l.CashBillModel,r=global_config.root,d=global_const.loadingImg,c=t.extend({initialize:function(t){c.__super__.initialize.apply(this,arguments),this.initCollection()},onClickExport:function(t){t.preventDefault();var e=this.collectParams(),a=e.tradeStartTime,l=e.tradeEndTime;if(!a||!l){var n=new i;return n.show("请选择入账起止时间!"),void n.on("goahead",function(){this.hide()})}var s=Date.parse(a.replace(/\-/g,"/")),r=Date.parse(l.replace(/\-/g,"/")),d=Math.floor((r-s)/1e3),c=259200;if(d>c){var h=new i;return h.show("时间跨度不允许超过3天！"),void h.on("goahead",function(){this.hide()})}var m=$(t.target).data("action");if(m){var u=this.tableListEl.find("tbody").children(),f=0==u.length||u.first().is(".nomore");if(!f){var p=o.format({path:m,query:e});p+="&reportId=12",window.open(p,"_download")}}},initCollection:function(){this.collection=new n,this.listenTo(this.collection,"reset",function(t,e){var i;if(t.length<1)i='<tr><td style="text-align: center;" colspan="100">没有更多数据</td></tr>';else{i=[];for(var a=0,l=t.length;a<l;a++){var o=new h({model:t.at(a)});o.render(),i.push(o.el)}}this.tableListEl.find(" > tbody").html(i)})},refreshTableDataList:function(t,e,i,a){if(t.length<1)this.collection.reset();else{var l=this.polish(t);this.collection.reset(l)}this.trigger("refreshdata.tablelist")}}),h=Backbone.View.extend({tagName:"tr",className:"bill-item",template:_.template($("#tableFieldTmpl").html(),{variable:"obj"}),events:{"click .btn-recharge":function(t){t.preventDefault(),this.model.set("isRecharge",!0),this.model.expand()},"click .expand-bill":function(t){t.preventDefault(),this.model.set("isRecharge",!1),this.model.toggle()}},initialize:function(){this.billView=new m({model:this.model}),this.listenTo(this.model,"expand",function(){this.billView.$el.insertAfter(this.$el),this.$el.addClass("z-active")}),this.listenTo(this.model,"collapse",function(){this.billView.$el.detach(),this.$el.removeClass("z-active")}),this.listenTo(this.model,"change:auditStatusMsg",this.render),this.listenTo(this.model.bills,"submited",function(t,i){if(0==t.code)this.model.set("isRecharge",!0),this.model.expand(),e.show("充值单提交成功");else if(t.code==-6005){var a=['<div style="margin-top: 40px;">',"流水银行卡",'<span class="color-danger"> ',this.model.get("counterAccountName")," ",this.model.get("counterBankName")," ",this.model.get("counterAccountNo")," </span>","与客户账户中银行卡信息不符，请修正。","</div>"].join("");e.show(a,null,[{text:"确定",style:"success",handler:function(){location.assign(r+"/v#/capital/account/virtual-acctount/"+t.data.virtualAccountUuid+"/detail")}}])}else e.show(t.message)})},render:function(){var t=this.model.toJSON(),e=this.template(t);this.$el.html(e)}}),m=Backbone.View.extend({tagName:"tr",className:"bill-card-box",template:_.template($("#CashBillTmpl").html(),{variable:"obj"}),events:{"click .add-bill":"onClickAddBill"},initialize:function(){this.listenTo(this.model.bills,"request",function(){var t=$('<td colspan="1000" style="text-align: center;">');t.append(d.clone()),this.$el.html(t)}),this.listenTo(this.model.bills,"destroy",function(){var t=this.model.getRemainDepositAmount();this.$(".doubt-amount").text(t)});var t=this.model.bills;this.listenTo(t,"reset",this.addAllBill),this.listenTo(t,"add",this.addOneBill)},addOneBill:function(t){var e=new u({model:t});e.render(),this.$(".record-list").append(e.$el)},addAllBill:function(){var t=this.model.bills;t.length<1&&this.model.set("isRecharge",!0);var e=this.model.toJSON();e.doubtAmount=this.model.getRemainDepositAmount();var i=$(this.template(e));this.$el.html(i);for(var a=0;a<t.length;a++)this.addOneBill(t.at(a))},onClickAddBill:function(t){t.preventDefault();var i=new s({},{collection:this.model.bills}),a=new f({model:i});this.listenToOnce(i,"created",function(t){0==t.code?this.model.bills.add(i):e.show(t.message)}),a.show()}}),u=Backbone.View.extend({tagName:"tr",template:_.template($("#CashBillItemTmpl").html(),{variable:"obj"}),events:{"click .btn-success":"onClickSbumit","click .btn-danger":"onClickDisable"},initialize:function(){this.confirmDisable=new i({cancelBtnTxt:"否",goaheadBtnTxt:"是"}),this.listenTo(this.confirmDisable,"goahead",function(){this.confirmDisable.hide(),this.model.disable()}),this.listenTo(this.model,"disabled",function(t){0!=t.code&&e.show(t.message)}),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"change",this.render)},render:function(){var t=this.model.collection.cashFlowAuditModel,e=this.model.toJSON();e.isRecharge=t.get("isRecharge");var i=this.template(e);this.$el.html(i)},toastErrorTip:function(t,e){var i=t.prev(".error"),a=12*e.length+30;i.length<1?(i=$('<span class="error">'+e+"</span>"),t.before(i)):i.html(e),i.width(a).addClass("anim-fadeIn");var l=t.data("timer");l&&clearTimeout(l),l=setTimeout(function(){i.fadeOut(500,function(){i.remove()})},4e3),t.data("timer",l)},validate:function(){var t=!0,e=this.$("[name=depositAmount]"),i=this.$("[name=remark]"),a=i.val().trim(),l=e.val().trim();return $.isNumeric(l)||(t=!1,this.toastErrorTip(e,"请输入非负数")),a||(t=!1,this.toastErrorTip(i,"请输入备注")),t},onClickSbumit:function(t){if(t.preventDefault(),this.validate()){var e={remark:this.$("[name=remark]").val().trim(),depositAmount:this.$("[name=depositAmount]").val().trim()};this.model.set(e,{silent:!0}),this.model.submit()}},onClickDisable:function(){this.confirmDisable.show("即将作废该充值账单，是否继续？")}}),f=a.extend({id:"createBillDialog",template:_.template($("#AddBillDialogTmpl").html()),events:{"keyup [name=keyWord]":"onKeyupKeyWord"},initialize:function(){f.__super__.initialize.apply(this,arguments);var t=this;this.$customerTypeMsg=this.$("[name=customerTypeMsg]"),this.$financialContractName=this.$("[name=financialContractName]"),this.$("[name=keyWord]").autocomplete({action:"./query-customer",container:this.$(".auto-complete-list"),parse:function(t){return 0==t.code?t.data.modelList:[]},search:function(e){return{name:e,customerType:t.$customerTypeMsg.val(),financialContractUuid:t.$financialContractName.val()}},parcelItem:function(t){var e='<li class="item" data-customeruuid="'+t.customerUuid+'"><span class="title">'+t.name+"("+t.number+")</span></li>";return e},onSubmit:function(t,e){t.val(e.text()).data("customeruuid",e.data("customeruuid"))}}),this.defineValidate()},defineValidate:function(){$.validator.addMethod("existCustomerUuid",function(t,e){return $(e).data("customeruuid")&&$(e).val()},""),this.validator=this.$(".form").validate({onfocusout:!1,rules:{customerTypeMsg:"required",financialContractName:"required",keyWord:"existCustomerUuid"}})},onKeyupKeyWord:function(t){$(t.target).data("customeruuid",null)},validate:function(){return this.validator.form()},extractDataFromDom:function(){var t={showData:{}},e=this.$financialContractName;t.showData.financialContractName=e.find("option:selected").text(),t.financialContractUuid=e.val();var i=this.$customerTypeMsg;return t.showData.customerTypeMsg=i.find("option:selected").text(),t.customerType=i.val(),t.customerUuid=this.$("[name=keyWord]").data("customeruuid"),t},save:function(t){var t=this.extractDataFromDom();this.model.set(t),this.model.create(t)},submitHandler:function(){this.validate()&&(this.save(),this.hide())}});module.exports=c});