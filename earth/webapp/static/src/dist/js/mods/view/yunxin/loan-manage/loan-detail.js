define(function(require,exports,module){var e=require("component/popupTip"),t=require("component/dialogView"),n=require("baseView/baseFormView").FormDialogView,a=jQuery,i=global_config.root,o=n.extend({template:_.template(a("#modifyNoteTmpl").html()),className:"modal fade form-modal small-form-modal",action:{save:i+""},initialize:function(){o.__super__.initialize.apply(this,arguments),this.defineValidator()},defineValidator:function(){this.validator=this.$("form").validate({rules:{note:{required:!0,maxlength:50}},messages:{note:{maxlength:"备注信息不超过50字"}}})},validate:function(){this.validator.form()},save:function(){var t={url:this.action.save,dataType:"json",data:""};t.success=function(t){1===t.code||e.show(t.message)},a.ajax(t)},submitHandler:function(){!this.validate()}}),l=n.extend({template:_.template(a("#resendRemittancePlanTmpl").html()),className:"modal fade form-modal small-form-modal",initialize:function(){l.__super__.initialize.apply(this,arguments),this.defineValidator()},defineValidator:function(){this.validator=this.$("form").validate({rules:{comment:{required:!0,maxlength:50}},messages:{comment:{maxlength:"备注信息不超过50字"}}})},validate:function(){return this.validator.form()},submitHandler:function(){this.validate()&&(this.model.set(this.extractDomData()),this.model.resendRemittancePlan(),this.hide())}}),s=n.extend({template:_.template(a("#channelLoanTmpl").html()),action:{save:i+""},initialize:function(){s.__super__.initialize.apply(this,arguments),this.defineValidator()},defineValidator:function(){this.validator=this.$("form").validate({rules:{channelSelect:"required"}})},validate:function(){this.validator.form()},save:function(){var t={url:this.action.save,dataType:"json",data:""};t.success=function(t){1==t.code||e.show(t.message)},a.ajax(t)},submitHandler:function(){!this.validate()}}),d=Backbone.Model.extend({actions:{resendRemittancePlan:function(e){return i+"/remittance/plan/resend?remittancePlanUuid="+e}},resendRemittancePlan:function(){var e=this.get("remittancePlanUuid"),t=this.get("plannedPaymentDate");if(t&&new Date(t)<=new Date("2016-10-10"))this.trigger("model:resend",{code:-1,message:"该贷款合同已生效，禁止再放款。请重新核对信息。"});else{var n={url:this.actions.resendRemittancePlan(e),dataType:"json",data:{comment:this.get("comment")}};n.success=function(e){this.trigger("model:resend",e)}.bind(this),a.ajax(n)}}}),r=Backbone.View.extend({el:".content",events:{"click #modifyNote":"onClickModifyNote","click #channelLoan":"onClickChannelLoan","click #resendRemittancePlan":"onClickResendRemittancePlan","mouseover .showPopover":"showPopover","mouseout .showPopover":"showPopover"},initialize:function(){this.initModel()},initModel:function(){var n={};n.remittancePlanUuid=this.$("[name=remittancePlanUuid]").val().trim(),n.plannedPaymentDate=this.$("#plannedPaymentDate").text().trim(),this.model=new d(n);var a=new t({excludeGoahed:!0});a.on("closedialog",function(){location.reload()}),this.listenTo(this.model,"model:resend",function(t){0==t.code?a.show("放款单，重新执行成功。"):e.show(t.message)})},onClickResendRemittancePlan:function(e){e.preventDefault();var t=new l({model:this.model});t.show()},onClickModifyNote:function(e){e.preventDefault();var t=new o;t.show()},onClickChannelLoan:function(e){e.preventDefault();var t=new s;t.show()},showPopover:function(e){var t=a(e.target),n=t.siblings(".account").html();t.popover({content:n}),t.popover("toggle")}});module.exports=r});